### 内核态和用户态

内核态用于执行一些特权指令，比如中断机制，原语，进程管理等，目的是保护系统程序。

内核态通常包括三个方面：==系统调用，中断和异常==

中断和异常都可以实现用户态到内核态的切换，是通过硬件实现的。

中断：IO完成，定时器时钟中断。

异常：越界，溢出，缺页，异常不能被屏蔽，一旦出现应立即处理。

### linux文件类型

- -普通文件
- d目录
- l符号连接
- s套接字
- b块文件
- c字符文件
- p管道

### 进程间通信IPC

- 信号

- 管道
- 消息队列
- 共享内存
- 套接字
- 信号量

### 命令

- 权限控制
- 查找排序去重

```shell
grep/find/chmod/chown/awk/sed/stat/fcntl/scp
netstat -anp | grep python //查看网络连接状态
cat /proc/meminfo // 查看内存信息
cat /proc/cpuinfo //查看cpu信息
free //查看磁盘信息
top //动态查看cpu信息 %cpu %mem pid
df //查看磁盘
tailf -1000 //查看日志
ulimit -a //显示目前资源限制的设定
echo $? //查看进程退出状态
sort -r //逆序 从大到小
sort -n //从小到大 数字
du hello.c //显示目录或文件的大小
file hello.c //识别文件类型
```

### 文件

open/read/write操作文件描述符三连

```c
ret = read(fds[0], buf, sizeof(buf)); //返回读取到的字节数
write(fds[1], str, strlen(str));
```

### fork

```c
int pid = fork()
if(pid > 0){} 父进程
else if(pid == 0){}子进程 -1表示失败
```

### pipe

本质是内核缓冲区，使用环形队列实现，默认大小是4k。

半双工，单方向流动数据

一读一写

```c
itn fds[2];
int ret = pipe(fds);
0表示成功 -1表示失败
```

### exec

fork出子进程后，希望子进程执行另外一个可执行程序。

调用exec函数以后，进程的用户空间数据（.text和.data）被新程序所替换,进程id不改变。

```c
execlp("ls","随便什么都可以","-l","-a",NULL); //最后一定要传入NULL用于指示不定长参数的结尾
```

### 信号

信息量比较小，开销小，不可靠，有时延。每个进程收到的所有信号，都是由内核负责发送的，内核处理。

产生信号：kill raise abort 段错误 除0 按键

信号机制：信号屏蔽字（阻塞信号集），未决信号集。放在PCB进程控制块中。

未决信号集bitmap

处理方式：忽略/捕获/默认

注册信号捕捉函数

SIGSEGV    SEGKILL　SIGALRM    SIGINT

```c
void my_handler(int sig){
    printf("hello world!\n");
    abort(); //终止进程
}
int main(){
    signal(SIGALRM, my_handler); //注册信号捕捉函数
    alarm(1); //定时
    for(int i = 0; ; i++){
        printf("%d\n",i);
    }
    return 0;
}
```

### alarm

定时器，只能支持到秒级，与进程状态无关，进程挂起时也在计时中。

每个进程都有且只有一个唯一个定时器，二次调用覆盖原来的定时器，返回原来定时的剩余时间。

```c
alarm(5) //5秒后程序终止
alarm(0) //取消闹钟
```

setitimer微秒级定时

### 动态分配内存

分配策略

- 首次适应：地址递增最先满足条件的内存
- 最佳适应：容量递增最先满足条件的内存
- 循环适应：首次适应的优化版，从上次分配的位置开始。

### 分页内存管理

固定分区会产生内部碎片，动态分区会产生外部碎片。分页使用相等的页面大小，内存和进程都进行划分，由于页面较小，所以每个进程平均产生半个页的内部碎片。分页管理是从计算机的角度考虑设计的，页面的大小对用户是透明的。分段管理是从用户的角度去设计的，为了满足编程的方便，信息保护和共享等多方面的需要。

逻辑地址：页号P + 页内偏移量W

物理地址：b*L + W

页表项：页号P + 物理内存的块号b

页面大小必须相等

页表：由页表项组成。

地址转换机构：逻辑地址---快表TLB---页表---物理地址

两次访问主存，如果使用了快表就可以实现只访问一次主存拿数据和指令

多级页表：减少页表所占的连续内存空间。

### 分段内存管理

逻辑地址：段号S + 段内偏移量W

段表：由段表项组成。

段表项：段号S + 段长L + 起始地址b

物理地址：b + W (需要判断b是否小于等于L)

### 段页内存管理

逻辑地址：段号S + 页号P + 页内偏移量W

每个进程有一个段表，每个段有一个页表。

段页式存储既有分页也有分段的优点，采用分段来分配和管理用户地址空间，用分页来管理物理存储空间，但它的开销最大。

### 虚拟内存

局部性原理：时间局部性和空间局部性。

部分页面装入内存

缺页中断机制

页面置换算法：最佳置换算法，最近最少使用，先进先出，时钟算法

抖动：页面频繁调度

Belady问题：FIFO中随着物理块的增加，缺页故障反而增加。

### 进程调度算法

- 先来先服务：属于不可剥夺算法，对长作业有利，对短作业不利，有利于CPU繁忙，不利于IO繁忙。
- 短作业优先：对于长作业会产生饥饿，即长期不被调度。
- 优先级调度：从就绪队列中选择优先级最高的进程，分配CPU
- 高响应比优先调度：主要用于作业调度，克服了饥饿状态，兼顾了长作业。
- 时间片轮转：主要适用于分时系统，剥夺式算法
- 多级反馈队列

